<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><title>Load Balancer with HAProxy for Chef Server (RightLink 10)</title><meta content="This RigthLink 10 ServerTemplate contains scripts and inputs that allow it to connect to application servers private/public IP address. It is one of the core ServerTemplates in a typical a three-tier website architecture." name="description" /><meta content="initial-scale=1" name="viewport" /><link href="https://my.rightscale.com/favicon.ico" rel="icon" /><!--Stylesheets--><link href="../../../css/main.css" rel="stylesheet" /><!--JavaScript--><script src="../../../js/main.js"></script></head><body class="st st_rl10 st_rl10_lb st_rl10_lb_index" data-spy="scroll" data-target="#subnav-right"><nav class="navbar navbar-default navbar-fixed-top" role="navigation"><div class="container-fluid max-width"><div class="navbar-header"><button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/"><img src="../../../img/FX_Logo_pos.png" /></a></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav navbar-right"><li><a target="_blank" href="https://community.flexera.com/t5/Flexera-Community/ct-p/Flexera_Community">Community</a></li><li><a target="_blank" href="https://www.flexera.com/blog/">Blog</a></li><li><a target="_blank" href="https://www.flexera.com/about-us/contact-us.html">Contact</a></li><li><a target="_blank" href="https://login.rightscale.com/login/session/new">Log In</a></li></ul><ul class="nav navbar-nav navbar-right nav-status"><li class="nav-al-search"><a href="../../../search.html">Search</a></li></ul><form class="navbar-form navbar-left" role="search" action="/search.html" method="get" ><div class="form-group"><input class="form-control input-sm" id="site-search" placeholder="Search" type="text" name="q" /></div><input type="submit" style="position: absolute; left: -9999px"/></form><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script><script type="text/javascript"> docsearch({apiKey: 'b58c3ad6ab9d6e3cd425867d64a6766f',indexName: 'rightscale',inputSelector: '#site-search', debug: false, autocompleteOptions: {autoselect: false}});</script></div></div></nav><div class="wrap"><div class="container-fluid max-width"><div class="row"><div class="col-sm-3"><div class="clearfix"><aside class="main-nav" role="complementary"><nav class="list-group" role="navigations"><a class="list-group-item" href="/st"><h4 class="list-group-heading"><img src="../../../img/product-cloud-management.svg" /><span>ServerTemplates</span></h4></a><a class="list-group-item" href="../../about.html">About</a><a class="list-group-item" href="/st/rl10">Version RL10</a><a class="list-group-item" href="../../open-source/">Open Source</a></nav></aside><div class="callout"><a href="/api/"><div class="panel panel-default"><div class="panel-body"><div class="callout-title"><img src="../../../img/icon-api.svg" /><h4>Flexera CMP APIs</h4></div><span>See the API reference documentation for all of our products.</span></div></div></a></div><div class="callout"><a href="../../../ca/cloud_comp/ca_getting_started_with_cloud_comparison.html"><div class="panel panel-default"><div class="panel-body"><div class="callout-title"><img src="../../../img/icon-cloud-blue.svg" /><h4>Cloud Comparison</h4></div><span>Compare public clouds based on the features they offer.</span></div></div></a></div><div class="callout"><a target="_blank" href="http://feedback.rightscale.com"><div class="panel panel-default"><div class="panel-body"><div class="callout-title"><img src="../../../img/icon-feedback.svg" /><h4>Feedback</h4></div><span>Get in touch and we’ll get back to you as soon as we can.</span></div></div></a></div><div class="callout"><a href="/release-notes"><div class="panel panel-default"><div class="panel-body"><div class="callout-title"><img src="../../../img/icon-notes.svg" /><h4>Release Notes</h4></div><span>See the notes for the latest releases of each application and what’s changed.</span></div></div></a></div></div></div><div class="col-sm-9"><div class="row"><div class="col-sm-9"><div class="clearfix"><p><a href="../../../">Flexera CMP Docs</a> &#x2F; <a href="../../">ServerTemplates</a> &#x2F; <a href="../">Version RightLink 10 ServerTemplates</a></p><div class="page-header"><h1>Load Balancer with HAProxy for Chef Server (RightLink 10)</h1></div><div class="main-content"><h2 id="overview">Overview</h2>

<p>Configures a dedicated HAProxy load balancer. The ServerTemplate contains scripts and inputs that allow it to connect to application servers private/public IP address. The ServerTemplate is one of the core ServerTemplates in a typical a three-tier website architecture.</p>

<div class="alert alert-info" role="alert"><strong>Note:</strong><p>This ServerTemplate requires a Chef Server with the required cookbooks (see below under Requirements) uploaded to the Chef Server to work.</p>
</div>

<p><strong>Note:</strong> For a complete list of the ServerTemplate&#39;s features and support, view the detailed description under its <strong>Info</strong> tab.</p>

<h2 id="requirements">Requirements</h2>

<ul>
<li>Chef Server or Hosted Chef</li>
<li><a href="https://github.com/rightscale-cookbooks/rs-haproxy">rs-haproxy</a> (<a href="https://github.com/rightscale-cookbooks/rs-haproxy/releases/tag/v2.0.1">2.0.1</a>)</li>
</ul>

<h2 id="technical-overview">Technical Overview</h2>

<p>HAProxy (High Availability Proxy) is a software load balancer. It is generally used to direct client web traffic to an array of application servers. The scripts associated with the ServerTemplate installs the HAProxy. The following are the scripts in the Boot Sequence and Operational section:</p>

<p><strong>Boot Sequence:</strong>
See <a href="/st/rl10/base_linux/index.html">RightLink 10 Linux Base </a> for details on the default scripts.</p>

<ul>
<li><strong>Chef Client Install</strong> - This script installs and configures the chef client.</li>
<li><strong>HAProxy Install - chef</strong> - Installs HAProxy by downloading the source package and compiling it. This recipe simply sets up the HAProxy configuration file using the haproxy LWRP, enables, and starts the HAProxy service. If the ‘HAProxy SSL Certificate’ input is set then this recipe will configure HTTPS support on the HAProxy server. All HTTP requests will be redirected to HTTPS in this scenario.</li>
<li><strong>HAProxy Frontend - chef</strong> - This script can be used in two different contexts.

<ol>
<li>To attach all existing application servers in the deployment to the corresponding pools served by the HAProxy server. This recipe finds application servers in the deployment by querying for the application tags on the application server. Only the application servers whose application name matches one of the pool names in HAProxy are identified and attached to the HAProxy server.</li>
<li>To be run as a remote recipe for attaching/detaching a single application server to/from the HAProxy servers. To attach a single application server, the server invoking the remote recipe call should set the action attribute to attach and pass its application name, bind IP address and port, server UUID, and the virtual host name to the HAProxy server. To detach a single application server, this attribute should be set to detach and the invoking server should pass its application name and the server UUID to the HAProxy server. Refer to rs_run_recipe utility for making remote recipe calls and passing information to the remote recipe.</li>
</ol></li>
<li><strong>HAProxy Schedule - chef</strong> -   Creates a crontab entry to run the <code>HAProxy Frontend - chef</code> script to attach all active application servers.</li>
</ul>

<p><strong>Operational Scripts:</strong></p>

<ul>
<li><strong>HAProxy Frontend - chef</strong> - This script can be used in two different contexts.

<ol>
<li>To attach all existing application servers in the deployment to the corresponding pools served by the HAProxy server. This recipe finds application servers in the deployment by querying for the application tags on the application server. Only the application servers whose application name matches one of the pool names in HAProxy are identified and attached to the HAProxy server.</li>
<li>To be run as a remote recipe for attaching/detaching a single application server to/from the HAProxy servers. To attach a single application server, the server invoking the remote recipe call should set the action attribute to attach and pass its application name, bind IP address and port, server UUID, and the virtual host name to the HAProxy server. To detach a single application server, this attribute should be set to detach and the invoking server should pass its application name and the server UUID to the HAProxy server. Refer to rs_run_recipe utility for making remote recipe calls and passing information to the remote recipe.</li>
</ol></li>
<li><strong>HAProxy Schedule - chef</strong> -   Creates a crontab entry to run the <code>HAProxy Frontend - chef</code> script to attach all active application servers.<br></li>
</ul>

<h3 id="technical-overview-general-best-practices">General Best Practices</h3>

<ol>
<li>Select an instance type that best meets your application&#39;s performance requirements. If possible, select an instance type that offers more memory or guaranteed interface/bandwidth I/O, which is ideal for a load balancer server.</li>
<li>Launch load balancer servers in different availability zones or datacenters (if supported by the cloud) for additional protection against outages in a single zone affecting your entire web application. Typically, application servers and HAProxy load balancer servers will be in the same cloud.</li>
</ol>

<h3 id="technical-overview-support-for-multiple-load-balancing-pools">Support for Multiple Load Balancing Pools</h3>

<p>Although the ServerTemplate is commonly used to launch a set of load balancer servers that round-robin incoming web requests for a single application across an array of dedicated applications servers, it can also be configured to load balance across multiple applications using multiple vhosts. For example, if you have two different applications (e.g. free and pay versions) where both applications connect to the same database, you could create a single deployment where the same load balancer servers send traffic to the appropriate application tier.</p>

<p><img src="/img/st-3tier-array.png" alt="st-3tier-array.png" width="483" height="391" /></p>

<p><strong>Example: 1 Load Balancing Pool</strong></p>

<p><img src="/img/st-3tier-mult-vhosts.png" alt="st-3tier-mult-vhosts.png" width="552" height="373" /></p>

<p><strong>Example: 2 Load Balancing Pools</strong></p>

<h3 id="technical-overview-session-stickiness">Session Stickiness</h3>

<p>If you want a user&#39;s session to be maintained, set the <strong>Use Session Stickiness</strong> input to <strong>True</strong> to configure the load balancers to send a user&#39;s subsequent requests to the same application server. However, it&#39;s important to remember that session stickiness will only work if an end user&#39;s browser allows and stores the session cookie from the load balancer. Set to <strong>False</strong> to disable session stickiness and configure the load balancers to distribute incoming requests in a round-robin fashion across all serviceable application servers.</p>

<h3 id="technical-overview-load-balancing-algorithm">Load Balancing Algorithm</h3>

<p>By default, the load balancers will distribute incoming requests to the application servers in its load balancing pool in a round-robin fashion. (e.g. 1,2,3,1,2,3,1...) However, the ServerTemplate also has built-in supports for a few other configurations. Use the <strong>Load Balancing Algorithm</strong> input to select the load balancing logic that&#39;s best suited for your application.</p>

<ul>
<li><strong>roundrobin</strong> (default) - Incoming requests are distributed in a round-robin fashion. (a-b-c-a-b-...)</li>
<li><strong>leastconn</strong> - Incoming requests are sent to the server with the fewest number of active connections.</li>
<li><strong>source</strong> - Incoming requests from the same client IP address will be sent to the same application server.</li>
</ul>

<p>To learn more, see the <a href="http://haproxy.1wt.eu/download/1.6/doc/configuration.txt">HAProxy Configuration Manual</a>.</p>

<h3 id="technical-overview-haproxy-status-report--health-check-page-">HAProxy Status Report (Health Check Page)</h3>

<p>HAProxy includes a built-in health-checking feature that allows it to monitor registered application servers to determine if they are running and accepting connections (up). To enable this feature, each application server must have an identically named health check page that will return an HTTP 200 OK status back to the HAProxy server each time a load balancer issues an HTTP GET request. The health-check page helps distinguish your application servers from other servers running outside of your deployment.</p>

<p>Go to the HAProxy Status page to verify that all of the application servers are properly connected to the load balancer servers. The default location of the status page is defined by the <strong>Statistics URI</strong> input. By default, it&#39;s set to the value ‘<strong>/haproxy-status</strong>’. (e.g. http://www.example.com/haproxy-status) You may optionally set the <strong>Statistics Page Username</strong> and <strong>Statistics Page Password</strong> inputs in order to require a user name and password to log in and view the page.</p>

<p><img src="/img/st-HAProxy-status.png" alt="st-HAProxy-status.png" width="727" height="403" /></p>
</div></div></div><div class="col-sm-3 hidden-xs affix-parent"><div class="clearfix" data-clampedwidth=".affix-parent" data-offset-bottom="200" data-offset-top="4" data-spy="affix"><nav class="subnav-right" id="subnav-right" role="sub-nav"><script>createRightHandNav();</script></nav></div></div></div></div></div></div></div><footer class="main-footer" role="contentinfo"><div class="container-fluid max-width"><div class="row"><div class="col-sm-10"><ul class="list-inline"><li><small>&copy; 2024 Flexera</small></li><li><a href="http://www.flexera.com/" target="_blank"><small>Flexera Home</small></a></li><li><a href="https://www.flexera.com/about-us/careers.html" target="_blank"><small>We're Hiring</small></a></li></ul></div></div></div></footer><noscript><iframe height="0" src="//www.googletagmanager.com/ns.html?id=GTM-KB9SMN" style="display:none;visibility:hidden" width="0"></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-KB9SMN');</script><script type="text/javascript">
  // Add clipboard button trigger
  var snippets = document.querySelectorAll('.syntax-highlight');
  [].forEach.call(snippets, function(snippet) {
  snippet.firstChild.insertAdjacentHTML('beforebegin', '<button class="btn snippet-clipboard" data-clipboard-snippet><img src="/img/icon-clipboard.svg"></button>');
  });

  // clipboard trigger
  var clipboardSnippets = new Clipboard('[data-clipboard-snippet]', {
  target: function(trigger) {
  return trigger.nextElementSibling;
  }
  });

  // Tooltip trigger
  clipboardSnippets.on('success', function(e) {
  e.clearSelection();
  showTooltip(e.trigger, 'Copied!');
  });

  // Error message
  clipboardSnippets.on('error', function(e) {
  showTooltip(e.trigger, fallbackMessage(e.action));
  });

  // Tooltip events
  var btns = document.querySelectorAll('.syntax-highlight .btn');
  for (var i = 0; i < btns.length; i++) {
  btns[i].addEventListener('mouseleave', clearTooltip);
  btns[i].addEventListener('blur', clearTooltip);
  }

  function clearTooltip(e) {
  e.currentTarget.setAttribute('class', 'btn');
  e.currentTarget.removeAttribute('aria-label');
  }

  function showTooltip(elem, msg) {
  elem.setAttribute('class', 'btn tooltipped tooltipped-s');
  elem.setAttribute('aria-label', msg);
  }
</script></body></html>